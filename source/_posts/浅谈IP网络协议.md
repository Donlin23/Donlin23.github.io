---
title: 浅谈IP网络协议
date: 2018-06-04 10:55:58
tags: 网络协议
categories: 信息安全
---

### IP网络协议详解

> IP协议(Internet Protocol)，计算机网络中最核心的一个协议，工作在网络体系结构中的网络层，下面写下这篇文章总结一下IP协议的各个方面的知识点。

首先，我们来了解一下IP协议提供的服务。IP协议位于网络层，是TCP/IP协议族中最为核心的协议，所有的TCP、UDP、ICMP以及IGMP数据都是以IP数据报(IP Datagram)格式进行传输。IP协议提供的是不可靠、无连接的数据报传输服务。
* 不可靠(unreliable)：IP协议不能保证数据报能成功地到达目的地，它仅提供传输服务。当发生某种错误是，IP协议会丢弃该数据报。传输的可靠性全由上层协议来提供。
* 无连接(connetionless)：IP协议对每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。如果发送方向接收方发送了两个连续的数据报(先是A，后是B)，每个数据报可以选择不同的路线，因此B可能在A到达之前先到达。

接下来，我们看一下IP数据报的格式。

![IP_Datagram](http://img3.ph.126.net/vBeH9eDewhj4Kx24a1m0dA==/2791950294010152753.jpg)

1. 版本。4位，用于标明IP版本号，0100表示IPv4，0110表示IPv6,。
2. 首部长度。4位，用于表示IP报头的长度，如果有可选字段，也包括可选字段。
3. 服务类型。8位，表示该报文需要的服务类型。前三位表示优先级，D位表示时延(0普通，1最小)，T位表示吞吐量(0普通，1最大)，R位表示可靠性(0普通，1最大)，C位表示花费(0普通，1最小)。最后一位未用。
4. 总长度。16位，表示报头长度加上数据部分的长度。最长可达65535字节。
5. 标识。16位，IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。
6. 标志。3位，标志字段中的最低位记为MF(More Fragment)。MF=1即表示后面“还有分片”的数据报。MF=0表示这已是若干数据报片中的最后一个。标志字段中间的一位记为DF(Don’t Fragment)，意思是“不能分片”。只有当DF=0时才允许分片。另一位无意义。
7. 片偏移。13位，片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对用户数据字段的起点，该片从何处开始。片偏移以8Byte为偏移单位。这就是说，除了最后一个分片，每个分片的长度一定是8B(字节)的整数倍。下面给出一个计算分片偏移的Example：

> 一个长4000B的IP数据报，数据部分3980B,到达了一个路由，需要转发到一个MTU为1500B的链路上，这样就得分片了。分片数目是3片。每个片都是一个数据报。假设标识是777，那么数据报分片结果是： \
分片一：标识：777，MF=1，DF=0,片偏移=0，有效数据：1480B(编号0~1479) \
分片二：标识：777，MF=1,DF=0,片偏移=185，185\*8=1480，有效数据：1480B(编号1480~2959) \
分片三：标识：777，MF=0,DF=0,片偏移370，370*8=2960，有效数据：1020B(编号2960~3979)

8. 生存时间(TTL)。8位，用于设置数据报可以经过的最多的路由器个数。TTL 的初始值由源主机设置（通常为 32 或 64），每经过一个处理它的路由器，TTL 值减 1。如果一个数据报的 TTL 值被减至 0，它将被丢弃。
9. 协议。8位，用来标识是哪个协议向 IP 传送数据。ICMP 为 1，IGMP 为 2，TCP 为 6，UDP 为 17，GRE 为 47，ESP 为 50。
10. 首部校验和。16位，根据IP报头计算的校验和码。下面给出一个计算校验和码的Example：

> IP头:\
45 00 00 31 \
89 F5 00 00\
6E 06 00 00 (校验字段)\
DE B7 45 5D  --> 222.183.69.93\
C0 A8 00 DC  --> 192.168.0.220\
计算：\
4500 + 0031 + 89F5 + 0000 + 6e06+ 0000 + DEB7 + 455D + C0A8 + 00DC =3 22C4\
0003 + 22C4 = 22C7\
~22C7 = DD38  --> 即为应填充的校验和\
当接受到IP数据包时，要检查IP头是否正确，则对IP头进行检验，方法同上：\
计算：\
4500 + 0031 +89F5 + 0000 + 6E06+ DD38 + DEB7 + 455D + C0A8 + 00DC =3 FFFC \
0003 + FFFC = FFFF 得到的结果是全一，正确。

下面，我们来总结一下IP协议的路由选择过程。当一个路由器接收到一个IP数据报后会进行以下路由选择：
1. 搜索路由表，如果能找到和目的IP地址完全一致的主机，则将IP数据报转发给该主机；
2. 搜索路由表，如果匹配主机失败，则匹配同一子网的路由器(这需要子网掩码的协助)。如果找到路由器，则将IP数据报发给该路由器；
3. 搜索路由表，如果匹配同一子网路由器失败，则匹配同网络号路由器，如果找到路由器，则将IP数据报发给该路由器；
4. 如果以上都失败，就搜索默认路由，转发给默认路由；
5. 以上都失败，就丢弃这个数据报；
6. 如果在转发的过程中，IP数据报的TTL生命周期已经被减为0，则该数据报就被抛弃。

参考资料：<br>
[实验楼实验-TCP/IP网络协议基础 IP](https://www.shiyanlou.com/courses/98/labs/474/document)
